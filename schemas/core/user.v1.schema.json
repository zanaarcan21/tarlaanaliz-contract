{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://api.tarlaanaliz.com/schemas/core/user.v1.schema.json",
  "title": "User",
  "description": "User core model (PII-free). Contains user identity, roles, status, and RBAC claims. NO email/TCKN/OTP fields.",
  "type": "object",
  "properties": {
    "id": {
      "$ref": "#/$defs/UserId",
      "description": "Unique user identifier"
    },
    "display_name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 100,
      "description": "User's display name (may be pseudonymous)"
    },
    "roles": {
      "type": "array",
      "items": {
        "type": "string",
        "description": "User roles (reference: enums/role.enum.v1.json)"
      },
      "minItems": 1,
      "uniqueItems": true,
      "description": "Assigned roles"
    },
    "status": {
      "type": "string",
      "enum": ["ACTIVE", "INACTIVE", "SUSPENDED", "PENDING_VERIFICATION", "DELETED"],
      "default": "PENDING_VERIFICATION",
      "description": "User account status"
    },
    "rbac_claims": {
      "$ref": "#/$defs/RbacClaims",
      "description": "RBAC claims for authorization"
    },
    "organization": {
      "$ref": "#/$defs/OrganizationRef",
      "description": "Organization affiliation (for COOP_ADMIN, IL_OPERATOR)"
    },
    "preferences": {
      "$ref": "#/$defs/UserPreferences",
      "description": "User preferences"
    },
    "verification": {
      "$ref": "#/$defs/VerificationStatus",
      "description": "Verification status"
    },
    "activity": {
      "$ref": "#/$defs/ActivityMetadata",
      "description": "Activity metadata"
    },
    "created_at": {
      "$ref": "#/$defs/Timestamp",
      "description": "Account creation timestamp"
    },
    "updated_at": {
      "$ref": "#/$defs/Timestamp",
      "description": "Last update timestamp"
    },
    "last_login_at": {
      "$ref": "#/$defs/Timestamp",
      "description": "Last login timestamp"
    },
    "metadata": {
      "type": "object",
      "additionalProperties": true,
      "description": "Optional metadata for extensions"
    }
  },
  "required": [
    "id",
    "display_name",
    "roles",
    "status",
    "rbac_claims",
    "created_at",
    "updated_at"
  ],
  "unevaluatedProperties": false,
  "$defs": {
    "UserId": {
      "type": "string",
      "pattern": "^user_[a-z0-9]{24}$",
      "description": "User identifier format: user_{24-char-hex}"
    },
    "RbacClaims": {
      "type": "object",
      "title": "RBAC Claims",
      "description": "Role-based access control claims",
      "properties": {
        "scopes": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "uniqueItems": true,
          "description": "Permission scopes (e.g., 'fields:read', 'missions:write')"
        },
        "resource_constraints": {
          "type": "object",
          "additionalProperties": true,
          "description": "Resource-level constraints (e.g., province_code for IL_OPERATOR)"
        },
        "effective_until": {
          "$ref": "#/$defs/Timestamp",
          "description": "Optional expiration for temporary elevated permissions"
        }
      },
      "required": ["scopes"],
      "unevaluatedProperties": false
    },
    "OrganizationRef": {
      "type": "object",
      "title": "Organization Reference",
      "description": "Organization affiliation",
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^org_[a-z0-9]{24}$",
          "description": "Organization identifier"
        },
        "name": {
          "type": "string",
          "description": "Organization name"
        },
        "type": {
          "type": "string",
          "enum": ["COOPERATIVE", "PRODUCER_UNION", "PROVINCIAL_OFFICE", "PLATFORM"],
          "description": "Organization type"
        },
        "province_code": {
          "type": "string",
          "pattern": "^[0-9]{2}$",
          "description": "Province code (for IL_OPERATOR)"
        }
      },
      "required": ["id", "name", "type"],
      "unevaluatedProperties": false
    },
    "UserPreferences": {
      "type": "object",
      "title": "User Preferences",
      "properties": {
        "language": {
          "type": "string",
          "enum": ["tr", "en"],
          "default": "tr",
          "description": "Preferred language"
        },
        "timezone": {
          "type": "string",
          "default": "Europe/Istanbul",
          "description": "Preferred timezone (IANA)"
        },
        "notification_channels": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["SMS", "PUSH", "IN_APP"]
          },
          "uniqueItems": true,
          "description": "Enabled notification channels (NOTE: SMS requires phone in user_pii)"
        },
        "notification_frequency": {
          "type": "string",
          "enum": ["REAL_TIME", "DAILY_DIGEST", "WEEKLY_DIGEST"],
          "default": "REAL_TIME",
          "description": "Notification frequency"
        }
      },
      "unevaluatedProperties": false
    },
    "VerificationStatus": {
      "type": "object",
      "title": "Verification Status",
      "properties": {
        "phone_verified": {
          "type": "boolean",
          "default": false,
          "description": "Phone verification status"
        },
        "phone_verified_at": {
          "$ref": "#/$defs/Timestamp",
          "description": "Phone verification timestamp"
        },
        "identity_verified": {
          "type": "boolean",
          "default": false,
          "description": "Identity verification status (for pilots, operators)"
        },
        "identity_verified_at": {
          "$ref": "#/$defs/Timestamp",
          "description": "Identity verification timestamp"
        },
        "verification_method": {
          "type": "string",
          "enum": ["PHONE_PIN", "MANUAL_REVIEW", "THIRD_PARTY"],
          "description": "Verification method used"
        }
      },
      "unevaluatedProperties": false
    },
    "ActivityMetadata": {
      "type": "object",
      "title": "Activity Metadata",
      "properties": {
        "total_missions": {
          "type": "integer",
          "minimum": 0,
          "description": "Total missions (for pilots)"
        },
        "total_fields": {
          "type": "integer",
          "minimum": 0,
          "description": "Total fields (for farmers)"
        },
        "total_flight_hours": {
          "type": "number",
          "minimum": 0,
          "description": "Total flight hours (for pilots)"
        },
        "reputation_score": {
          "type": "number",
          "minimum": 0,
          "maximum": 100,
          "description": "Reputation/quality score (for pilots)"
        }
      },
      "unevaluatedProperties": false
    },
    "Timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp (UTC)"
    }
  },
  "examples": [
    {
      "id": "user_507f191e810c19729de860ea",
      "display_name": "Ahmet K.",
      "roles": ["FARMER"],
      "status": "ACTIVE",
      "rbac_claims": {
        "scopes": [
          "fields:read:own",
          "fields:write:own",
          "missions:request",
          "analysis:read:own"
        ]
      },
      "preferences": {
        "language": "tr",
        "timezone": "Europe/Istanbul",
        "notification_channels": ["SMS", "IN_APP"],
        "notification_frequency": "REAL_TIME"
      },
      "verification": {
        "phone_verified": true,
        "phone_verified_at": "2026-01-10T12:00:00Z",
        "identity_verified": false,
        "verification_method": "PHONE_PIN"
      },
      "activity": {
        "total_fields": 3,
        "total_missions": 12
      },
      "created_at": "2026-01-10T10:30:00Z",
      "updated_at": "2026-01-26T14:45:00Z",
      "last_login_at": "2026-01-26T14:45:00Z"
    },
    {
      "id": "user_60a7f1b8c9d4e5f6a7b8c9d0",
      "display_name": "Pilot Mehmet Y.",
      "roles": ["PILOT"],
      "status": "ACTIVE",
      "rbac_claims": {
        "scopes": [
          "missions:read:assigned",
          "missions:update:assigned",
          "intake:create",
          "payroll:read:own"
        ]
      },
      "preferences": {
        "language": "tr",
        "timezone": "Europe/Istanbul",
        "notification_channels": ["SMS", "PUSH"],
        "notification_frequency": "REAL_TIME"
      },
      "verification": {
        "phone_verified": true,
        "phone_verified_at": "2025-12-01T10:00:00Z",
        "identity_verified": true,
        "identity_verified_at": "2025-12-05T14:30:00Z",
        "verification_method": "MANUAL_REVIEW"
      },
      "activity": {
        "total_missions": 147,
        "total_flight_hours": 89.5,
        "reputation_score": 92.5
      },
      "created_at": "2025-12-01T09:00:00Z",
      "updated_at": "2026-01-26T08:15:00Z",
      "last_login_at": "2026-01-26T08:15:00Z"
    },
    {
      "id": "user_60a7f1b8c9d4e5f6a7b8c9d1",
      "display_name": "İl Operatörü - Diyarbakır",
      "roles": ["IL_OPERATOR"],
      "status": "ACTIVE",
      "rbac_claims": {
        "scopes": [
          "missions:read:province",
          "missions:update:province",
          "missions:assign",
          "pilots:read:province",
          "reports:read:province"
        ],
        "resource_constraints": {
          "province_code": "21"
        }
      },
      "organization": {
        "id": "org_60a7f1b8c9d4e5f6a7b8c9d2",
        "name": "Diyarbakır İl Müdürlüğü",
        "type": "PROVINCIAL_OFFICE",
        "province_code": "21"
      },
      "preferences": {
        "language": "tr",
        "timezone": "Europe/Istanbul",
        "notification_channels": ["IN_APP"],
        "notification_frequency": "DAILY_DIGEST"
      },
      "verification": {
        "phone_verified": true,
        "phone_verified_at": "2025-11-15T10:00:00Z",
        "identity_verified": true,
        "identity_verified_at": "2025-11-15T14:00:00Z",
        "verification_method": "MANUAL_REVIEW"
      },
      "created_at": "2025-11-15T09:00:00Z",
      "updated_at": "2026-01-20T10:00:00Z",
      "last_login_at": "2026-01-26T07:30:00Z"
    }
  ],
  "notes": {
    "pii_absolutely_forbidden": "CRITICAL: This schema MUST NOT contain email, TCKN, or OTP fields. These are stored separately in user_pii.v1.schema.json.",
    "phone_identity": "Identity is based on phone + PIN (6 digits). Phone is stored in user_pii, NOT here.",
    "rbac": "Authorization uses roles + scopes. Multi-role support (e.g., FARMER + COOP_ADMIN).",
    "display_name": "display_name may be pseudonymous or truncated for privacy (e.g., 'Ahmet K.' instead of full name).",
    "verification": "phone_verified is critical gate. Users cannot perform actions until phone is verified.",
    "kr_reference": "User model and auth flow defined in KR-050 (Identity), KR-063 (RBAC).",
    "separation_of_concerns": "Core user data (this schema) is separate from PII (user_pii) and authentication (JWT tokens)."
  }
}